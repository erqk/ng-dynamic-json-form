name: Pre-render docs content and deploy to GitHub pages

on:
  push:
    branches:
      - "v*" # Matches v1, v2, v3, etc.
      - "main" # Optional: keep main branch
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for version detection

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: 📦 Install dependencies
        run: npm ci

      # Get major version from branch name
      - name: 🏷️ Get major version
        id: get_version
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Current branch: $BRANCH_NAME"

          if [[ $BRANCH_NAME =~ ^v[0-9]+$ ]]; then
            # Branch name is already in format v1, v2, etc.
            VERSION=$BRANCH_NAME
            echo "Using branch name as version: $VERSION"
          elif [[ $BRANCH_NAME == "main" ]]; then
            # For main branch, try to get version from lib/package.json or git tag
            if [ -f "lib/package.json" ]; then
              FULL_VERSION=$(node -p "require('./lib/package.json').version" 2>/dev/null || echo "")
              echo "Full version from lib/package.json: $FULL_VERSION"
              if [[ -n "$FULL_VERSION" && "$FULL_VERSION" != "undefined" ]]; then
                MAJOR_VERSION=$(echo $FULL_VERSION | cut -d. -f1)
                VERSION="v$MAJOR_VERSION"
                echo "Extracted major version from lib/package.json: $VERSION"
              else
                echo "Could not read version from lib/package.json, trying git tags..."
                FULL_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "")
                if [[ -n "$FULL_VERSION" ]]; then
                  MAJOR_VERSION=$(echo $FULL_VERSION | cut -d. -f1)
                  VERSION="v$MAJOR_VERSION"
                  echo "Extracted major version from git tag: $VERSION"
                else
                  echo "No git tags found, defaulting to v1"
                  VERSION="v1"
                fi
              fi
            else
              echo "No lib/package.json found, trying git tags..."
              FULL_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "")
              if [[ -n "$FULL_VERSION" ]]; then
                MAJOR_VERSION=$(echo $FULL_VERSION | cut -d. -f1)
                VERSION="v$MAJOR_VERSION"
                echo "Extracted major version from git tag: $VERSION"
              else
                echo "No git tags found, defaulting to v1"
                VERSION="v1"
              fi
            fi
          else
            # Fallback: extract version from branch name or use branch name
            VERSION=$(echo $BRANCH_NAME | grep -oE 'v[0-9]+' || echo "v1")
            echo "Fallback version: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Final detected major version: $VERSION"

      - name: ⚙️ Run prerender pipeline
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          npm run build:docs

      # Setup major versioned directory structure and replace version placeholder
      - name: 📁 Setup versioned docs
        run: |
          VERSION=${{ steps.get_version.outputs.version }}

          # Debug: Check what was actually built
          echo "=== Checking build output ==="
          ls -la ./dist/ || echo "No dist directory"
          ls -la ./dist/docs/ || echo "No dist/docs directory"
          ls -la ./dist/docs/browser/ || echo "No dist/docs/browser directory"

          mkdir -p ./versioned-docs/$VERSION

          # Check if source files exist before copying
          if [ -d "./dist/docs/browser" ]; then
            echo "=== Files in ./dist/docs/browser ==="
            ls -la ./dist/docs/browser/
            
            # Handle Angular's new prerender structure BEFORE copying
            if [ -f "./dist/docs/browser/index.csr.html" ] && [ ! -f "./dist/docs/browser/index.html" ]; then
              echo "Found index.csr.html but no index.html - copying csr as index for newer Angular"
              cp "./dist/docs/browser/index.csr.html" "./dist/docs/browser/index.html"
              echo "Successfully created index.html from index.csr.html"
            fi
            
            # Verify we now have index.html
            if [ -f "./dist/docs/browser/index.html" ]; then
              echo "✅ index.html exists - proceeding with copy"
              # Debug: Show content of index.html before copying
              echo "=== Content of built index.html (first 10 lines) ==="
              head -10 ./dist/docs/browser/index.html
              echo "=== Looking for base href in built index.html ==="
              grep "base href" ./dist/docs/browser/index.html || echo "No base href found in built file"
            else
              echo "❌ ERROR: Still no index.html after attempting to create from index.csr.html"
              exit 1
            fi
            
            cp -r ./dist/docs/browser/* ./versioned-docs/$VERSION/
          else
            echo "❌ ERROR: ./dist/docs/browser directory does not exist!"
            exit 1
          fi

          # Check what was actually copied
          echo "=== Files copied to versioned-docs/$VERSION ==="
          ls -la ./versioned-docs/$VERSION/

          echo "Replacing {{VERSION}} placeholder with actual version: $VERSION (after prerender)"

          # Debug: Show what we're looking for before replacement in specific folders
          echo "=== Looking for {{VERSION}} placeholder before replacement in browser and server folders ==="
          find ./versioned-docs/$VERSION -path "*/browser/*.html" -o -path "*/server/*.html" | head -10 | xargs grep -H "{{VERSION}}" 2>/dev/null || echo "No {{VERSION}} placeholder found in browser/server HTML files"

          # Replace {{VERSION}} placeholder specifically in base href tags only - AFTER prerender
          # Target only HTML files in browser and server directories
          find ./versioned-docs/$VERSION \( -path "*/browser/*.html" -o -path "*/server/*.html" \) -type f -exec sed -i "s|<base href=\"/ng-dynamic-json-form/{{VERSION}}/\">|<base href=\"/ng-dynamic-json-form/$VERSION/\">|g" {} \;

          # Also handle the case where the closing tag might be different
          find ./versioned-docs/$VERSION \( -path "*/browser/*.html" -o -path "*/server/*.html" \) -type f -exec sed -i "s|<base href=\"/ng-dynamic-json-form/{{VERSION}}\">|<base href=\"/ng-dynamic-json-form/$VERSION/\">|g" {} \;

          # Verify the replacement worked in the main index.html
          echo "=== Checking base href after replacement ==="
          find ./versioned-docs/$VERSION -name "index.html" -exec grep -H "base href" {} \; || echo "No base href found"

          # Debug: Show if any {{VERSION}} placeholders remain in browser/server folders
          echo "=== Checking for remaining {{VERSION}} placeholders in browser/server folders ==="
          find ./versioned-docs/$VERSION \( -path "*/browser/*.html" -o -path "*/server/*.html" \) | head -10 | xargs grep -H "{{VERSION}}" 2>/dev/null || echo "No placeholders remaining in browser/server - good!"

          # Debug: Show final index.html content
          if [ -f "./versioned-docs/$VERSION/index.html" ]; then
            echo "=== Final index.html content (first 10 lines) ==="
            head -10 ./versioned-docs/$VERSION/index.html
          fi

          # Create or update root index.html that redirects to latest major version
          cat > ./versioned-docs/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Documentation</title>
            <meta http-equiv="refresh" content="0; url=./$VERSION/">
            <link rel="canonical" href="./$VERSION/">
          </head>
          <body>
            <p>Redirecting to <a href="./$VERSION/">latest documentation ($VERSION)</a>...</p>
          </body>
          </html>
          EOF

          # Only create 404.html if index.html exists in the version directory
          if [ -f "./versioned-docs/$VERSION/index.html" ]; then
            cp ./versioned-docs/$VERSION/index.html ./versioned-docs/404.html
            echo "Created 404.html from versioned index.html"
          else
            echo "⚠️ WARNING: No index.html found in version directory, creating simple 404.html"
            cat > ./versioned-docs/404.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Page Not Found</title>
          </head>
          <body>
            <h1>404 - Page Not Found</h1>
            <p><a href="/">Go to documentation home</a></p>
          </body>
          </html>
          EOF
          fi

      # Preserve existing major versions from previous deployment
      - name: 🔄 Preserve existing versions
        run: |
          # Create a temporary directory for existing content
          mkdir -p ./temp-existing

          # Since we're using actions/deploy-pages, previous versions aren't in gh-pages branch
          # Try to discover existing versions dynamically from the live site
          echo "Attempting to discover and preserve existing versions from live site..."

          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          BASE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/$REPO_NAME"
          CURRENT_VERSION="${{ steps.get_version.outputs.version }}"

          echo "Checking for existing versions at: $BASE_URL"

          # Method 1: Try to get the root page and parse for version links
          echo "Attempting to discover versions from root page..."
          if curl -f -s "$BASE_URL/" -o ./temp-root.html 2>/dev/null; then
            # Look for version links in the root page (like v1/, v2/, etc.)
            DISCOVERED_VERSIONS=$(grep -oE 'href="[./]*v[0-9]+/"' ./temp-root.html | sed 's/href="[./]*\(v[0-9]\+\)\//\1/' | sort -u || echo "")
            if [ -n "$DISCOVERED_VERSIONS" ]; then
              echo "Discovered versions from root page: $DISCOVERED_VERSIONS"
              for version in $DISCOVERED_VERSIONS; do
                if [ "$version" != "$CURRENT_VERSION" ]; then
                  echo "Checking discovered version: $version"
                  if curl -f -s "$BASE_URL/$version/" > /dev/null 2>&1; then
                    echo "✅ Confirmed existing version: $version"
                    mkdir -p "./temp-existing/$version"
                    echo "<!-- Existing version $version will be preserved -->" > "./temp-existing/$version/placeholder.html"
                  fi
                fi
              done
            fi
            rm -f ./temp-root.html
          fi

          # Method 2: Fallback - try common version patterns up to v20
          if [ ! -d "./temp-existing" ] || [ -z "$(ls -A ./temp-existing 2>/dev/null)" ]; then
            echo "No versions discovered from root page, trying systematic check..."
            for i in {1..20}; do
              version="v$i"
              if [ "$version" != "$CURRENT_VERSION" ]; then
                echo "Checking if $version exists..."
                if curl -f -s "$BASE_URL/$version/" > /dev/null 2>&1; then
                  echo "✅ Found existing version: $version"
                  mkdir -p "./temp-existing/$version"
                  echo "<!-- Existing version $version will be preserved -->" > "./temp-existing/$version/placeholder.html"
                fi
              fi
            done
          fi

          # Show what we found
          if [ -d "./temp-existing" ] && [ -n "$(ls -A ./temp-existing 2>/dev/null)" ]; then
            echo "Found existing versions to preserve:"
            ls -la ./temp-existing/
          else
            echo "No existing versions found - this might be the first deployment or all previous versions are inaccessible"
          fi

          # For now, skip complex preservation and just deploy the current version
          echo "Note: Full version preservation is temporarily disabled"
          echo "Current deployment will only include: $CURRENT_VERSION"

          # List all major versions for debugging
          echo "Available major versions after preservation:"
          ls -la ./versioned-docs/

      - name: ⚙️ Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: 📤 Upload versioned artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./versioned-docs"

      - name: 🚀 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
