<ng-container
  *ngIf="!configs || (!$any(configs.length) && !$any(configs).configs)"
>
  No config found
</ng-container>

<ng-container *ngIf="!!configValidateErrors?.length">
  <div class="config-validation-error">
    <p>Config validation failed. Please check.</p>
    <ng-container *ngFor="let error of configValidateErrors">
      <p>
        {{ error }}
      </p>
    </ng-container>
  </div>
</ng-container>

<ng-container *ngIf="!!configGet?.length && !!form">
  <ng-container
    *ngTemplateOutlet="
      formGroupTemplate;
      context: {
        parentForm: form,
        controlConfigs: configGet
      }
    "
    [formGroup]="form"
  ></ng-container>
</ng-container>

<ng-template
  #formGroupTemplate
  let-parentForm="parentForm"
  let-controlConfigs="controlConfigs"
  let-isNested="isNested"
  let-parentId="parentId"
  let-hostLayout="hostLayout"
>
  <div
    class="grid-container"
    [controlLayout]="{
      type: 'host',
      layout: hostLayout
    }"
  >
    <ng-container [formGroup]="parentForm">
      <ng-container *ngFor="let config of controlConfigs">
        <!-- Form control -->
        <ng-container *ngIf="!config.children && !config.formArray">
          <div
            class="form-control-container"
            [hostId]="{
              parentId,
              controlName: config.formControlName,
            }"
            [controlLayout]="{
              type: 'host',
              layout: config?.layout
            }"
            [ngClass]="{
              readonly: config?.readonly,
            }"
          >
            <ng-container
              *ngIf="config.label && config?.layout?.hideLabel !== true"
              [ngTemplateOutlet]="formTitleTemplate"
              [ngTemplateOutletContext]="{
                config,
                collapsibleEl: formControlContent,
                control: parentForm.controls[config.formControlName]
              }"
            ></ng-container>

            <div #formControlContent>
              <!-- Description (before) -->
              <ng-container
                *ngIf="
                  config?.description &&
                  config?.layout?.descriptionPosition !== 'after'
                "
                [ngTemplateOutlet]="descriptionTemplate"
                [ngTemplateOutletContext]="{
                  description: config.description,
                  layout: config.layout
                }"
              ></ng-container>

              <form-control
                style="display: block"
                [controlLayout]="{
                  type: 'content',
                  layout: config.layout
                }"
                [data]="config"
                [control]="parentForm.controls[config.formControlName]"
                [form]="form"
                [formControlName]="config.formControlName"
                [customComponent]="customComponents?.[config?.customComponent]"
                [uiComponents]="uiComponentsGet"
                [layoutComponents]="layoutComponents"
                [layoutTemplates]="layoutTemplates"
                [inputTemplates]="inputTemplates"
                [hideErrorMessage]="hideErrorMessage"
              ></form-control>

              <!-- Description (after) -->
              <ng-container
                *ngIf="
                  config?.description &&
                  config?.layout?.descriptionPosition === 'after'
                "
                [ngTemplateOutlet]="descriptionTemplate"
                [ngTemplateOutletContext]="{
                  description: config.description,
                  layout: config.layout
                }"
              ></ng-container>
            </div>
          </div>
        </ng-container>

        <!-- Form group -->
        <ng-container *ngIf="!!config.children && !config.formArray">
          <div
            class="form-group-container"
            [hostId]="{
              parentId,
              controlName: config.formControlName
            }"
            [controlLayout]="{
              type: 'host',
              isNested: isNested === true,
              layout: config?.layout,
            }"
            [ngClass]="{
              readonly: config?.readonly,
            }"
          >
            <!-- Label -->
            <ng-container
              *ngIf="config.label && config?.layout?.hideLabel !== true"
              [ngTemplateOutlet]="formTitleTemplate"
              [ngTemplateOutletContext]="{
                config,
                collapsibleEl: formGroupContent,
                control: parentForm.controls[config.formControlName]
              }"
            ></ng-container>

            <div #formGroupContent>
              <!-- Description (before) -->
              <ng-container
                *ngIf="
                  config?.description &&
                  config?.layout?.descriptionPosition !== 'after'
                "
                [ngTemplateOutlet]="descriptionTemplate"
                [ngTemplateOutletContext]="{
                  description: config.description,
                  layout: config.layout
                }"
              ></ng-container>

              <ng-container
                [ngTemplateOutlet]="formGroupTemplate"
                [ngTemplateOutletContext]="{
                controlConfigs: config.children,
                parentId:
                  (parentId ? parentId + '.' : '') + config.formControlName,
                parentForm: parentForm.controls[config.formControlName],
                isNested: true && !(config?.layout?.hideLabel === true || !config?.label),
                hostLayout: {
                  hostClass: config?.layout?.contentClass,
                  hostStyles: config?.layout?.contentStyles,
                }
              }"
              ></ng-container>

              <!-- Description (after) -->
              <ng-container
                *ngIf="
                  config?.description &&
                  config?.layout?.descriptionPosition === 'after'
                "
                [ngTemplateOutlet]="descriptionTemplate"
                [ngTemplateOutletContext]="{
                  description: config.description,
                  layout: config.layout
                }"
              ></ng-container>
            </div>

            <error-message
              [control]="parentForm.controls[config.formControlName]"
              [validators]="config.validators"
              [layout]="config.layout"
              [layoutComponents]="layoutComponents"
              [layoutTemplates]="layoutTemplates"
              [hideErrorMessage]="hideErrorMessage"
            ></error-message>
          </div>
        </ng-container>

        <!-- Form array -->
        <ng-container
          *ngIf="
            !config.children &&
            !!config.formArray &&
            !!config.formArray.template.length
          "
        >
          <div
            class="form-array-container"
            [hostId]="{
              parentId,
              controlName: config.formControlName
            }"
            [controlLayout]="{
              type: 'host',
              isNested: isNested === true,
              layout: config?.layout,
            }"
            [ngClass]="{
              readonly: config?.readonly
            }"
          >
            <ng-container
              [ngTemplateOutlet]="formArrayTemplate"
              [ngTemplateOutletContext]="{
                config,
                parentForm,
                formArray: parentForm.controls[config.formControlName],
              }"
            ></ng-container>
          </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<!-- FormArray -->
<ng-template
  #formArrayTemplate
  let-config="config"
  let-parentForm="parentForm"
  let-formArray="formArray"
>
  <ng-container [formGroup]="parentForm">
    <!-- Label -->
    <ng-container
      *ngIf="config?.label"
      [ngTemplateOutlet]="formTitleTemplate"
      [ngTemplateOutletContext]="{
        config,
        collapsibleEl: formArrayContent,
        control: parentForm
      }"
    >
    </ng-container>

    <div #formArrayContent>
      <ng-container
        *ngIf="config?.description"
        [ngTemplateOutlet]="descriptionTemplate"
        [ngTemplateOutletContext]="{
          description: config.description,
          layout: config?.layout
        }"
      ></ng-container>

      <!-- Show add button when form array is empty -->
      <ng-container
        *ngIf="
          config?.formArray?.editable === true && !formArray.controls.length
        "
      >
        <form-array-item-header
          [config]="config.formArray"
          [formArray]="formArray"
          [layoutComponents]="layoutComponents"
          [layoutTemplates]="layoutTemplates"
        ></form-array-item-header>
      </ng-container>

      <ng-container formArrayName="{{ config.formControlName }}">
        <error-message
          [control]="formArray"
          [validators]="config?.validators"
        ></error-message>

        <ng-container
          *ngFor="let formGroup of formArray.controls; index as index"
        >
          <div class="group">
            <!-- FormGroup header -->
            <form-array-item-header
              [config]="config.formArray"
              [formArray]="formArray"
              [index]="index"
              [layoutComponents]="layoutComponents"
              [layoutTemplates]="layoutTemplates"
            ></form-array-item-header>

            <!-- FormGroup -->
            <ng-container
              *ngTemplateOutlet="
                formGroupTemplate;
                context: {
                  parentId: config.formControlName,
                  parentForm: formGroup,
                  isNested: true,
                  controlConfigs: config.formArray.template
                }
              "
            ></ng-container>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </ng-container>
</ng-template>

<!-- Form title template -->
<ng-template
  #formTitleTemplate
  let-config="config"
  let-collapsibleEl="collapsibleEl"
  let-control="control"
>
  <form-title
    [label]="config.label"
    [layout]="config.layout"
    [extra]="config.extra"
    [collapsibleEl]="collapsibleEl"
    [customTemplate]="labelTemplates?.[config?.customLabel ?? ''] ?? layoutTemplates?.formTitle"
    [customComponent]="labelComponents?.[config?.customLabel ?? ''] ?? layoutComponents?.formTitle"
    [state]="collapsibleState"
    [ngClass]="{
      required:
        config?.layout?.autoAddRequiredClass === false
          ? null
          : (control | isControlRequired)
    }"
  ></form-title>
</ng-template>

<!-- Description template -->
<ng-template
  #descriptionTemplate
  let-description="description"
  let-layout="layout"
>
  <span
    class="form-description"
    [controlLayout]="{
      type: 'description',
      layout
    }"
    >{{ description }}</span
  >
</ng-template>
