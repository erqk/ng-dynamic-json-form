<ng-container *ngIf="!configs"> Please pass in your JSON string </ng-container>

<ng-container *ngIf="!!configValidateErrors?.length">
  <div class="config-validation-error">
    <p>Config validation failed. Please check.</p>
    <ng-container *ngFor="let error of configValidateErrors">
      <p>
        {{ error }}
      </p>
    </ng-container>
  </div>
</ng-container>

<ng-container *ngIf="!!config?.length && !!form">
  <ng-container
    *ngTemplateOutlet="
      formGroupTemplate;
      context: {
        parentForm: form,
        controlConfigs: config
      }
    "
    [formGroup]="form"
  ></ng-container>
</ng-container>

<ng-template
  #formGroupTemplate
  let-parentForm="parentForm"
  let-controlConfigs="controlConfigs"
  let-isNested="isNested"
  let-parentId="parentId"
  let-hostLayout="hostLayout"
>
  <div
    class="grid-container"
    [controlLayout]="{
      type: 'host',
      layout: hostLayout
    }"
  >
    <ng-container [formGroup]="parentForm">
      <ng-container *ngFor="let config of controlConfigs">
        <!-- Form control -->
        <ng-container *ngIf="!config.children && !config.formArray">
          <div
            class="form-control-container"
            [hostId]="{
              parentId,
              controlName: config.formControlName,
            }"
            [controlLayout]="{
              type: 'host',
              layout: config?.layout,
              readonly: config?.readonly
            }"
            [ngClass]="{
              'level-1': isNested !== true
            }"
          >
            <form-control
              [data]="config"
              [control]="parentForm.controls[config.formControlName]"
              [form]="form"
              [formControlName]="config.formControlName"
              [customComponent]="customComponents?.[config.customComponent]"
              [uiComponents]="uiComponentsGet"
            ></form-control>
          </div>
        </ng-container>

        <!-- Form group -->
        <ng-container *ngIf="!!config.children && !config.formArray">
          <div
            class="form-group-container"
            [hostId]="{
              parentId,
              controlName: config.formControlName
            }"
            [controlLayout]="{
              type: 'host',
              isNested: isNested === true,
              layout: config?.layout,
              readonly: config?.readonly
            }"
          >
            <!-- Label -->
            <ng-container
              *ngIf="config.label && config?.layout?.hideLabel !== true"
              [ngTemplateOutlet]="labelTemplate"
              [ngTemplateOutletContext]="{
                label: config?.label,
                layout: config?.layout
              }"
            ></ng-container>

            <!-- Description -->
            <ng-container
              *ngIf="config.description"
              [ngTemplateOutlet]="descriptionTemplate"
              [ngTemplateOutletContext]="{ description: config.description }"
            ></ng-container>

            <ng-container
              [ngTemplateOutlet]="formGroupTemplate"
              [ngTemplateOutletContext]="{
                controlConfigs: config.children,
                parentId:
                  (parentId ? parentId + '.' : '') + config.formControlName,
                parentForm: parentForm.controls[config.formControlName],
                isNested: true,
                hostLayout: {
                  hostClass: config?.layout?.childClass,
                  hostStyles: config?.layout?.childStyles
                }
              }"
            ></ng-container>
          </div>
        </ng-container>

        <!-- Form array -->
        <ng-container
          *ngIf="
            !config.children &&
            !!config.formArray &&
            !!config.formArray.template.length
          "
        >
          <div
            class="form-array-container"
            [hostId]="{
              parentId,
              controlName: config.formControlName
            }"
            [controlLayout]="{
              type: 'host',
              isNested: isNested === true,
              layout: config?.layout,
              readonly: config?.readonly
            }"
          >
            <ng-container
              [ngTemplateOutlet]="formArrayTemplate"
              [ngTemplateOutletContext]="{
                label: config?.layout?.hideLabel === true ? '' : config.label,
                layout: config.layout,
                description: config.description,
                parentForm: parentForm,
                validators: config.validators,
                formArray: parentForm.controls[config.formControlName],
                formArrayName: config.formControlName,
                formArrayConfig: config.formArray
              }"
            ></ng-container>
          </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>

<!-- FormArray -->
<ng-template
  #formArrayTemplate
  let-label="label"
  let-layout="layout"
  let-description="description"
  let-parentForm="parentForm"
  let-validators="validators"
  let-formArray="formArray"
  let-formArrayName="formArrayName"
  let-formArrayConfig="formArrayConfig"
  let-isNested="isNested"
>
  <ng-container [formGroup]="parentForm">
    <!-- Label -->
    <ng-container
      *ngIf="label"
      [ngTemplateOutlet]="labelTemplate"
      [ngTemplateOutletContext]="{
        label,
        layout
      }"
    ></ng-container>

    <ng-container
      *ngIf="description"
      [ngTemplateOutlet]="descriptionTemplate"
      [ngTemplateOutletContext]="{
        description
      }"
    ></ng-container>

    <!-- Show add button when form array is empty -->
    <ng-container
      *ngIf="
        formArrayConfig.editable === true && formArray.controls.length === 0
      "
      [ngTemplateOutlet]="formArrayGroupHeader"
      [ngTemplateOutletContext]="{
          label,
          formArray,
          formArrayConfig
        }"
    ></ng-container>

    <ng-container formArrayName="{{ formArrayName }}">
      <error-message
        [control]="formArray"
        [validators]="validators"
      ></error-message>

      <ng-container
        *ngFor="let formGroup of formArray.controls; index as index"
      >
        <div class="group">
          <!-- FormGroup header -->
          <ng-container
            *ngIf="formArrayConfig.editable === true"
            [ngTemplateOutlet]="formArrayGroupHeader"
            [ngTemplateOutletContext]="{
              index,
              label,
              formArray,
              formArrayConfig
            }"
          ></ng-container>

          <!-- FormGroup -->
          <ng-container
            *ngTemplateOutlet="
              formGroupTemplate;
              context: {
                parentId: formArrayName,
                parentForm: formGroup,
                isNested: true,
                controlConfigs: formArrayConfig.template
              }
            "
          ></ng-container>
        </div>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<!-- Label template -->
<ng-template #labelTemplate let-label="label" let-layout="layout">
  <label
    class="form-title"
    [controlLayout]="{
      type: 'label',
      layout
    }"
    >{{ label }}</label
  >
</ng-template>

<!-- Description template -->
<ng-template #descriptionTemplate let-description="description">
  <span class="form-description">{{ description }}</span>
</ng-template>

<!-- Custom header of FormGroup inside FormArray -->
<ng-template
  #formArrayGroupHeader
  let-index="index"
  let-label="label"
  let-formArray="formArray"
  let-formArrayConfig="formArrayConfig"
>
  <div
    [ngClass]="{
      'form-array-group-header-custom': formArrayGroupHeaderRef,
      'form-array-group-header': !formArrayGroupHeaderRef
    }"
  >
    <ng-container
      [ngTemplateOutlet]="
        formArrayGroupHeaderRef ?? formArrayDefaultGroupHeader
      "
      [ngTemplateOutletContext]="{
        label: formArray.length
          ? formArrayConfig.templateLabel + ' ' + (index + 1)
          : '',
        index,
        formArray,
        templateForm: formArrayConfig.template | generateForm,
        buttonEvent:
          formArray | formArrayHeaderEvent : formArrayConfig.template : index
      }"
    ></ng-container>
  </div>
</ng-template>

<!-- Default header of FormGroup inside FormArray -->
<ng-template
  #formArrayDefaultGroupHeader
  let-label="label"
  let-formArray="formArray"
  let-buttonEvent="buttonEvent"
>
  <ng-container *ngIf="label">
    <span class="label">{{ label }}</span>
  </ng-container>

  <div class="buttons">
    <button type="button" class="btn-add" (click)="buttonEvent.add()">
      <span></span>
    </button>

    <ng-container *ngIf="formArray.length > 0">
      <button type="button" class="btn-remove" (click)="buttonEvent.remove()">
        <span></span>
      </button>
    </ng-container>
  </div>
</ng-template>
