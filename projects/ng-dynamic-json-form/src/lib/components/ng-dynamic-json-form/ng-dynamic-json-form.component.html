<ng-container *ngIf="jsonParsed && !!form && !reload">
  <form action="POST" [formGroup]="form">
    <ng-container
      *ngTemplateOutlet="
        formGroupTemplate;
        context: {
          parentForm: form,
          controlsData: jsonParsed
        }
      "
    ></ng-container>
  </form>
</ng-container>

<ng-container *ngIf="!jsonString">
  Please pass in your JSON string
</ng-container>

<ng-template
  #formGroupTemplate
  let-label="label"
  let-parentForm="parentForm"
  let-controlsData="controlsData"
  let-isNested="isNested"
>
  <span *ngIf="label" class="form-label">{{ label }}</span>

  <div class="form-grid-container">
    <ng-container [formGroup]="parentForm">
      <ng-container *ngFor="let control of controlsData">
        <!-- Form control -->
        <ng-container *ngIf="!control.children && !control.formArray">
          <app-form-control
            [data]="control"
            formControlName="{{ control.formControlName }}"
          ></app-form-control>
        </ng-container>

        <!-- Form group -->
        <ng-container *ngIf="!!control.children && !control.formArray">
          <div
            class="form-group-container"
            [ngClass]="{
              'nested-group': isNested === true
            }"
          >
            <ng-container
              *ngTemplateOutlet="
                formGroupTemplate;
                context: {
                  label: control.label,
                  parentForm: parentForm.controls[control.formControlName],
                  controlsData: control.children,
                  isNested: true
                }
              "
            ></ng-container>
          </div>
        </ng-container>

        <!-- Form array -->
        <ng-container
          *ngIf="
            !control.children &&
            !!control.formArray &&
            !!control.formArray.template.length
          "
        >
          <div class="form-array-container">
            <label class="form-label">{{ control.label }}</label>

            <!-- Show add button when form array is empty -->
            <div
              *ngIf="
                parentForm.controls[control.formControlName].controls.length ===
                0
              "
              class="form-array-group-header"
            >
              <div class="buttons">
                <button
                  class="btn-add"
                  (click)="
                    addFormGroup(
                      parentForm.controls[control.formControlName],
                      control.formArray.template
                    )
                  "
                >
                  <span></span>
                </button>
              </div>
            </div>

            <ng-container formArrayName="{{ control.formControlName }}">
              <ng-container
                *ngFor="
                  let formGroup of parentForm.controls[control.formControlName]
                    .controls;
                  index as i
                "
              >
                <div class="group">
                  <div class="form-array-group-header">
                    <span class="label"
                      >{{ control.formArray.templateLabel }} {{ i + 1 }}</span
                    >

                    <div class="buttons">
                      <ng-container *ngIf="control.formArray.editable === true">
                        <button
                          class="btn-add"
                          (click)="
                            addFormGroup(
                              parentForm.controls[control.formControlName],
                              control.formArray.template,
                              i + 1
                            )
                          "
                        >
                          <span></span>
                        </button>
                        <button
                          class="btn-remove"
                          (click)="
                            removeFormGroup(
                              parentForm.controls[control.formControlName],
                              i
                            )
                          "
                        >
                          <span></span>
                        </button>
                      </ng-container>
                    </div>
                  </div>
                  <ng-container
                    *ngTemplateOutlet="
                      formGroupTemplate;
                      context: {
                        parentForm: formGroup,
                        controlsData: control.formArray.template,
                        isNested: true
                      }
                    "
                  ></ng-container>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>
