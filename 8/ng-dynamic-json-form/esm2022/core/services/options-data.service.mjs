import { Injectable, inject, isDevMode } from '@angular/core';
import { EMPTY, Subject, catchError, combineLatest, debounceTime, distinctUntilChanged, map, of, startWith, switchMap, takeUntil, tap, } from 'rxjs';
import { evaluateConditionsStatements } from '../utilities/evaluate-conditions-statements';
import { getControlAndValuePath } from '../utilities/get-control-and-value-path';
import { getValueInObject } from '../utilities/get-value-in-object';
import { trimObjectByKeys } from '../utilities/trim-object-by-keys';
import { GlobalVariableService } from './global-variable.service';
import { HttpRequestCacheService } from './http-request-cache.service';
import * as i0 from "@angular/core";
class OptionsDataService {
    constructor() {
        this._globalVariableService = inject(GlobalVariableService);
        this._httpRequestCacheService = inject(HttpRequestCacheService);
        this._cancelAll$ = new Subject();
    }
    /**
     * @param srcConfig @see OptionSourceConfig
     * @param valueChangesCallback The callback after `valueChanges` is called
     */
    getOptions$(srcConfig, valueChangesCallback) {
        if (!srcConfig) {
            return EMPTY;
        }
        const event$ = () => {
            const valueChanges$ = this._onTriggerControlChanges$(srcConfig.filter || srcConfig.trigger, valueChangesCallback);
            if (srcConfig.filter) {
                return this._getOptionsByFilter$(srcConfig, valueChanges$);
            }
            if (srcConfig.trigger) {
                return this._getOptionsOnTrigger$(srcConfig, valueChanges$);
            }
            return this._getOptions$(srcConfig);
        };
        return event$().pipe(tap((x) => {
            if (isDevMode() && x.length > 100) {
                console.warn(`NgDynamicJsonForm:\nThe data length from the response ${srcConfig.url} is > 100.\n` +
                    `Please make sure there is optimization made. e.g. virtual scroll, lazy loading`);
            }
        }));
    }
    cancelAllRequest() {
        this._cancelAll$.next();
        this._httpRequestCacheService.reset();
    }
    onDestroy() {
        this.cancelAllRequest();
        this._cancelAll$.complete();
    }
    _getOptions$(srcConfig) {
        if (!srcConfig) {
            return EMPTY;
        }
        const { url, method, headers, mapData } = srcConfig;
        const bodyMapped = this._mapBodyValue(srcConfig);
        const src = this._getMappedSrc(url, bodyMapped);
        return this._httpRequestCacheService
            .request$({
            src,
            method,
            headers,
            body: bodyMapped,
        })
            .pipe(map((x) => this._mapData(x, mapData)), catchError(() => of([])), takeUntil(this._cancelAll$));
    }
    _getOptionsByFilter$(srcConfig, valueChanges$) {
        if (!srcConfig.filter)
            return of([]);
        const mapTupleFn = (tuple, triggerValue, optionItem) => {
            const [triggerValuePath, operator, optionValuePath] = tuple;
            return [
                getValueInObject(triggerValue, triggerValuePath),
                operator,
                getValueInObject(optionItem?.value, optionValuePath),
            ];
        };
        const filterOptions$ = this._getOptions$(srcConfig).pipe(switchMap((x) => combineLatest([of(x), valueChanges$])), map(([options, value]) => options.filter((optionItem) => {
            const result = evaluateConditionsStatements(srcConfig.filter.conditions, (e) => mapTupleFn(e, value, optionItem));
            return result;
        })));
        return filterOptions$.pipe(takeUntil(this._cancelAll$));
    }
    _getOptionsOnTrigger$(srcConfig, valueChanges$) {
        if (!srcConfig.trigger)
            return of([]);
        return valueChanges$.pipe(switchMap((x) => {
            const emptyValue = x === undefined || x === null || x === '';
            return emptyValue ? of([]) : this._getOptions$(srcConfig);
        }), takeUntil(this._cancelAll$));
    }
    /**The `valueChanges` of trigger control */
    _onTriggerControlChanges$(triggerConfig, valueChangesCallback) {
        if (!triggerConfig)
            return EMPTY;
        const { by, debounceTime: _debounceTime = 0 } = triggerConfig;
        if (!by.trim())
            return EMPTY;
        const form = this._globalVariableService.rootForm;
        const paths = getControlAndValuePath(by);
        const control = form?.get(paths.controlPath);
        if (!control) {
            if (isDevMode()) {
                console.warn(`Form control ${paths.controlPath} not found.`);
            }
            return EMPTY;
        }
        return control.valueChanges.pipe(startWith(control.value), distinctUntilChanged((a, b) => JSON.stringify(a) === JSON.stringify(b)), tap(() => valueChangesCallback && valueChangesCallback()), debounceTime(_debounceTime), map((x) => (!paths.valuePath ? x : getValueInObject(x, paths.valuePath))));
    }
    _mapData(input, mapData) {
        if (!input)
            return [];
        const { contentPath, slice, labelKey, valueKeys } = mapData ?? {};
        const data = contentPath ? getValueInObject(input, contentPath) : input;
        const filteredValueKeys = [...new Set(valueKeys)].filter(Boolean);
        if (!data || !Array.isArray(data))
            return [];
        const slicedData = data.slice(slice?.[0] ?? 0, slice?.[1] ?? data.length);
        const result = slicedData.map((item) => ({
            label: getValueInObject(item, labelKey),
            value: !filteredValueKeys.length
                ? item
                : trimObjectByKeys(item, filteredValueKeys),
        }));
        return result;
    }
    _getMappedSrc(src, body) {
        // url variables (.../:x/:y/:z)
        const urlVariables = src.match(/:([^/:\s]+)/g) || [];
        if (typeof body !== 'object') {
            return src;
        }
        if (!urlVariables.length) {
            return `${src}?${new URLSearchParams(body).toString()}`;
        }
        return Object.keys(body).reduce((acc, key) => {
            acc = acc.replace(`:${key}`, `${body[key]}`);
            return acc;
        }, src);
    }
    _mapBodyValue(config) {
        if (!config.trigger)
            return config.body;
        const triggerBody = config.trigger.body;
        if (!triggerBody)
            return null;
        const form = this._globalVariableService.rootForm;
        const result = Object.keys(triggerBody).reduce((acc, key) => {
            const { controlPath, valuePath } = getControlAndValuePath(triggerBody[key]);
            const control = form?.get(controlPath);
            const value = getValueInObject(control?.value, valuePath);
            acc[key] = !control ? triggerBody[key] : value;
            return acc;
        }, {});
        return result;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: OptionsDataService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: OptionsDataService }); }
}
export { OptionsDataService };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: OptionsDataService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9ucy1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWIvY29yZS9zZXJ2aWNlcy9vcHRpb25zLWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUNMLEtBQUssRUFFTCxPQUFPLEVBQ1AsVUFBVSxFQUNWLGFBQWEsRUFDYixZQUFZLEVBQ1osb0JBQW9CLEVBQ3BCLEdBQUcsRUFDSCxFQUFFLEVBQ0YsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsR0FBRyxHQUNKLE1BQU0sTUFBTSxDQUFDO0FBTWQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFDM0YsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDakYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDcEUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sOEJBQThCLENBQUM7O0FBRXZFLE1BQ2Esa0JBQWtCO0lBRC9CO1FBRVUsMkJBQXNCLEdBQUcsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDdkQsNkJBQXdCLEdBQUcsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDM0QsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO0tBNk4zQztJQTNOQzs7O09BR0c7SUFDSCxXQUFXLENBQ1QsU0FBNkIsRUFDN0Isb0JBQWdDO1FBRWhDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQs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QUMxRCxNQUFNLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxHQUFHLHNCQUFzQixDQUN2RCxXQUFXLENBQUMsR0FBRyxDQUFDLENBQ2pCLENBQUM7WUFFRixNQUFNLE9BQU8sR0FBRyxJQUFJLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sS0FBSyxHQUFHLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7WUFFMUQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUMvQyxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFTLENBQUMsQ0FBQztRQUVkLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7K0dBL05VLGtCQUFrQjttSEFBbEIsa0JBQWtCOztTQUFsQixrQkFBa0I7NEZBQWxCLGtCQUFrQjtrQkFEOUIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIGluamVjdCwgaXNEZXZNb2RlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBFTVBUWSxcbiAgT2JzZXJ2YWJsZSxcbiAgU3ViamVjdCxcbiAgY2F0Y2hFcnJvcixcbiAgY29tYmluZUxhdGVzdCxcbiAgZGVib3VuY2VUaW1lLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgbWFwLFxuICBvZixcbiAgc3RhcnRXaXRoLFxuICBzd2l0Y2hNYXAsXG4gIHRha2VVbnRpbCxcbiAgdGFwLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIENvbmRpdGlvbnNTdGF0ZW1lbnRUdXBsZSxcbiAgT3B0aW9uSXRlbSxcbiAgT3B0aW9uU291cmNlQ29uZmlnLFxufSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHsgZXZhbHVhdGVDb25kaXRpb25zU3RhdGVtZW50cyB9IGZyb20gJy4uL3V0aWxpdGllcy9ldmFsdWF0ZS1jb25kaXRpb25zLXN0YXRlbWVudHMnO1xuaW1wb3J0IHsgZ2V0Q29udHJvbEFuZFZhbHVlUGF0aCB9IGZyb20gJy4uL3V0aWxpdGllcy9nZXQtY29udHJvbC1hbmQtdmFsdWUtcGF0aCc7XG5pbXBvcnQgeyBnZXRWYWx1ZUluT2JqZWN0IH0gZnJvbSAnLi4vdXRpbGl0aWVzL2dldC12YWx1ZS1pbi1vYmplY3QnO1xuaW1wb3J0IHsgdHJpbU9iamVjdEJ5S2V5cyB9IGZyb20gJy4uL3V0aWxpdGllcy90cmltLW9iamVjdC1ieS1rZXlzJztcbmltcG9ydCB7IEdsb2JhbFZhcmlhYmxlU2VydmljZSB9IGZyb20gJy4vZ2xvYmFsLXZhcmlhYmxlLnNlcnZpY2UnO1xuaW1wb3J0IHsgSHR0cFJlcXVlc3RDYWNoZVNlcnZpY2UgfSBmcm9tICcuL2h0dHAtcmVxdWVzdC1jYWNoZS5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9wdGlvbnNEYXRhU2VydmljZSB7XG4gIHByaXZhdGUgX2dsb2JhbFZhcmlhYmxlU2VydmljZSA9IGluamVjdChHbG9iYWxWYXJpYWJsZVNlcnZpY2UpO1xuICBwcml2YXRlIF9odHRwUmVxdWVzdENhY2hlU2VydmljZSA9IGluamVjdChIdHRwUmVxdWVzdENhY2hlU2VydmljZSk7XG4gIHByaXZhdGUgX2NhbmNlbEFsbCQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gIC8qKlxuICAgKiBAcGFyYW0gc3JjQ29uZmlnIEBzZWUgT3B0aW9uU291cmNlQ29uZmlnXG4gICAqIEBwYXJhbSB2YWx1ZUNoYW5nZXNDYWxsYmFjayBUaGUgY2FsbGJhY2sgYWZ0ZXIgYHZhbHVlQ2hhbmdlc2AgaXMgY2FsbGVkXG4gICAqL1xuICBnZXRPcHRpb25zJChcbiAgICBzcmNDb25maWc6IE9wdGlvblNvdXJjZUNvbmZpZyxcbiAgICB2YWx1ZUNoYW5nZXNDYWxsYmFjazogKCkgPT4gdm9pZFxuICApOiBPYnNlcnZhYmxlPE9wdGlvbkl0ZW1bXT4ge1xuICAgIGlmICghc3JjQ29uZmlnKSB7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuXG4gICAgY29uc3QgZXZlbnQkID0gKCkgPT4ge1xuICAgICAgY29uc3QgdmFsdWVDaGFuZ2VzJCA9IHRoaXMuX29uVHJpZ2dlckNvbnRyb2xDaGFuZ2VzJChcbiAgICAgICAgc3JjQ29uZmlnLmZpbHRlciB8fCBzcmNDb25maWcudHJpZ2dlcixcbiAgICAgICAgdmFsdWVDaGFuZ2VzQ2FsbGJhY2tcbiAgICAgICk7XG5cbiAgICAgIGlmIChzcmNDb25maWcuZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9nZXRPcHRpb25zQnlGaWx0ZXIkKHNyY0NvbmZpZywgdmFsdWVDaGFuZ2VzJCk7XG4gICAgICB9XG5cbiAgICAgIGlmIChzcmNDb25maWcudHJpZ2dlcikge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0T3B0aW9uc09uVHJpZ2dlciQoc3JjQ29uZmlnLCB2YWx1ZUNoYW5nZXMkKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuX2dldE9wdGlvbnMkKHNyY0NvbmZpZyk7XG4gICAgfTtcblxuICAgIHJldHVybiBldmVudCQoKS5waXBlKFxuICAgICAgdGFwKCh4KSA9PiB7XG4gICAgICAgIGlmIChpc0Rldk1vZGUoKSAmJiB4Lmxlbmd0aCA+IDEwMCkge1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgIGBOZ0R5bmFtaWNKc29uRm9ybTpcXG5UaGUgZGF0YSBsZW5ndGggZnJvbSB0aGUgcmVzcG9uc2UgJHtzcmNDb25maWcudXJsfSBpcyA+IDEwMC5cXG5gICtcbiAgICAgICAgICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgdGhlcmUgaXMgb3B0aW1pemF0aW9uIG1hZGUuIGUuZy4gdmlydHVhbCBzY3JvbGwsIGxhenkgbG9hZGluZ2BcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBjYW5jZWxBbGxSZXF1ZXN0KCk6IHZvaWQge1xuICAgIHRoaXMuX2NhbmNlbEFsbCQubmV4dCgpO1xuICAgIHRoaXMuX2h0dHBSZXF1ZXN0Q2FjaGVTZXJ2aWNlLnJlc2V0KCk7XG4gIH1cblxuICBvbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5jYW5jZWxBbGxSZXF1ZXN0KCk7XG4gICAgdGhpcy5fY2FuY2VsQWxsJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0T3B0aW9ucyQoXG4gICAgc3JjQ29uZmlnOiBPcHRpb25Tb3VyY2VDb25maWdcbiAgKTogT2JzZXJ2YWJsZTxPcHRpb25JdGVtW10+IHtcbiAgICBpZiAoIXNyY0NvbmZpZykge1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cblxuICAgIGNvbnN0IHsgdXJsLCBtZXRob2QsIGhlYWRlcnMsIG1hcERhdGEgfSA9IHNyY0NvbmZpZztcbiAgICBjb25zdCBib2R5TWFwcGVkID0gdGhpcy5fbWFwQm9keVZhbHVlKHNyY0NvbmZpZyk7XG4gICAgY29uc3Qgc3JjID0gdGhpcy5fZ2V0TWFwcGVkU3JjKHVybCwgYm9keU1hcHBlZCk7XG5cbiAgICByZXR1cm4gdGhpcy5faHR0cFJlcXVlc3RDYWNoZVNlcnZpY2VcbiAgICAgIC5yZXF1ZXN0JCh7XG4gICAgICAgIHNyYyxcbiAgICAgICAgbWV0aG9kLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBib2R5TWFwcGVkLFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHgpID0+IHRoaXMuX21hcERhdGEoeCwgbWFwRGF0YSkpLFxuICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKFtdKSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9jYW5jZWxBbGwkKVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldE9wdGlvbnNCeUZpbHRlciQoXG4gICAgc3JjQ29uZmlnOiBPcHRpb25Tb3VyY2VDb25maWcsXG4gICAgdmFsdWVDaGFuZ2VzJDogT2JzZXJ2YWJsZTxhbnk+XG4gICk6IE9ic2VydmFibGU8T3B0aW9uSXRlbVtdPiB7XG4gICAgaWYgKCFzcmNDb25maWcuZmlsdGVyKSByZXR1cm4gb2YoW10pO1xuXG4gICAgY29uc3QgbWFwVHVwbGVGbiA9IChcbiAgICAgIHR1cGxlOiBDb25kaXRpb25zU3RhdGVtZW50VHVwbGUsXG4gICAgICB0cmlnZ2VyVmFsdWU6IGFueSxcbiAgICAgIG9wdGlvbkl0ZW06IE9wdGlvbkl0ZW0gfCBudWxsIHwgdW5kZWZpbmVkXG4gICAgKTogQ29uZGl0aW9uc1N0YXRlbWVudFR1cGxlID0+IHtcbiAgICAgIGNvbnN0IFt0cmlnZ2VyVmFsdWVQYXRoLCBvcGVyYXRvciwgb3B0aW9uVmFsdWVQYXRoXSA9IHR1cGxlO1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgZ2V0VmFsdWVJbk9iamVjdCh0cmlnZ2VyVmFsdWUsIHRyaWdnZXJWYWx1ZVBhdGgpLFxuICAgICAgICBvcGVyYXRvcixcbiAgICAgICAgZ2V0VmFsdWVJbk9iamVjdChvcHRpb25JdGVtPy52YWx1ZSwgb3B0aW9uVmFsdWVQYXRoKSxcbiAgICAgIF07XG4gICAgfTtcblxuICAgIGNvbnN0IGZpbHRlck9wdGlvbnMkID0gdGhpcy5fZ2V0T3B0aW9ucyQoc3JjQ29uZmlnKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKCh4KSA9PiBjb21iaW5lTGF0ZXN0KFtvZih4KSwgdmFsdWVDaGFuZ2VzJF0pKSxcbiAgICAgIG1hcCgoW29wdGlvbnMsIHZhbHVlXSkgPT5cbiAgICAgICAgb3B0aW9ucy5maWx0ZXIoKG9wdGlvbkl0ZW0pID0+IHtcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBldmFsdWF0ZUNvbmRpdGlvbnNTdGF0ZW1lbnRzKFxuICAgICAgICAgICAgc3JjQ29uZmlnLmZpbHRlciEuY29uZGl0aW9ucyEsXG4gICAgICAgICAgICAoZSkgPT4gbWFwVHVwbGVGbihlLCB2YWx1ZSwgb3B0aW9uSXRlbSlcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICApO1xuXG4gICAgcmV0dXJuIGZpbHRlck9wdGlvbnMkLnBpcGUodGFrZVVudGlsKHRoaXMuX2NhbmNlbEFsbCQpKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldE9wdGlvbnNPblRyaWdnZXIkKFxuICAgIHNyY0NvbmZpZzogT3B0aW9uU291cmNlQ29uZmlnLFxuICAgIHZhbHVlQ2hhbmdlcyQ6IE9ic2VydmFibGU8YW55PlxuICApOiBPYnNlcnZhYmxlPE9wdGlvbkl0ZW1bXT4ge1xuICAgIGlmICghc3JjQ29uZmlnLnRyaWdnZXIpIHJldHVybiBvZihbXSk7XG5cbiAgICByZXR1cm4gdmFsdWVDaGFuZ2VzJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKCh4KSA9PiB7XG4gICAgICAgIGNvbnN0IGVtcHR5VmFsdWUgPSB4ID09PSB1bmRlZmluZWQgfHwgeCA9PT0gbnVsbCB8fCB4ID09PSAnJztcbiAgICAgICAgcmV0dXJuIGVtcHR5VmFsdWUgPyBvZihbXSkgOiB0aGlzLl9nZXRPcHRpb25zJChzcmNDb25maWcpO1xuICAgICAgfSksXG4gICAgICB0YWtlVW50aWwodGhpcy5fY2FuY2VsQWxsJClcbiAgICApO1xuICB9XG5cbiAgLyoqVGhlIGB2YWx1ZUNoYW5nZXNgIG9mIHRyaWdnZXIgY29udHJvbCAqL1xuICBwcml2YXRlIF9vblRyaWdnZXJDb250cm9sQ2hhbmdlcyQoXG4gICAgdHJpZ2dlckNvbmZpZzogT3B0aW9uU291cmNlQ29uZmlnWyd0cmlnZ2VyJ10gfCBPcHRpb25Tb3VyY2VDb25maWdbJ2ZpbHRlciddLFxuICAgIHZhbHVlQ2hhbmdlc0NhbGxiYWNrPzogKCkgPT4gdm9pZFxuICApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICghdHJpZ2dlckNvbmZpZykgcmV0dXJuIEVNUFRZO1xuXG4gICAgY29uc3QgeyBieSwgZGVib3VuY2VUaW1lOiBfZGVib3VuY2VUaW1lID0gMCB9ID0gdHJpZ2dlckNvbmZpZztcbiAgICBpZiAoIWJ5LnRyaW0oKSkgcmV0dXJuIEVNUFRZO1xuXG4gICAgY29uc3QgZm9ybSA9IHRoaXMuX2dsb2JhbFZhcmlhYmxlU2VydmljZS5yb290Rm9ybTtcbiAgICBjb25zdCBwYXRocyA9IGdldENvbnRyb2xBbmRWYWx1ZVBhdGgoYnkpO1xuICAgIGNvbnN0IGNvbnRyb2wgPSBmb3JtPy5nZXQocGF0aHMuY29udHJvbFBhdGgpO1xuXG4gICAgaWYgKCFjb250cm9sKSB7XG4gICAgICBpZiAoaXNEZXZNb2RlKCkpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBGb3JtIGNvbnRyb2wgJHtwYXRocy5jb250cm9sUGF0aH0gbm90IGZvdW5kLmApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cblxuICAgIHJldHVybiBjb250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgc3RhcnRXaXRoKGNvbnRyb2wudmFsdWUpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKGEsIGIpID0+IEpTT04uc3RyaW5naWZ5KGEpID09PSBKU09OLnN0cmluZ2lmeShiKSksXG4gICAgICB0YXAoKCkgPT4gdmFsdWVDaGFuZ2VzQ2FsbGJhY2sgJiYgdmFsdWVDaGFuZ2VzQ2FsbGJhY2soKSksXG4gICAgICBkZWJvdW5jZVRpbWUoX2RlYm91bmNlVGltZSksXG4gICAgICBtYXAoKHgpID0+ICghcGF0aHMudmFsdWVQYXRoID8geCA6IGdldFZhbHVlSW5PYmplY3QoeCwgcGF0aHMudmFsdWVQYXRoKSkpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX21hcERhdGEoXG4gICAgaW5wdXQ6IE9iamVjdCxcbiAgICBtYXBEYXRhOiBPcHRpb25Tb3VyY2VDb25maWdbJ21hcERhdGEnXVxuICApOiBPcHRpb25JdGVtW10ge1xuICAgIGlmICghaW5wdXQpIHJldHVybiBbXTtcblxuICAgIGNvbnN0IHsgY29udGVudFBhdGgsIHNsaWNlLCBsYWJlbEtleSwgdmFsdWVLZXlzIH0gPSBtYXBEYXRhID8/IHt9O1xuICAgIGNvbnN0IGRhdGEgPSBjb250ZW50UGF0aCA/IGdldFZhbHVlSW5PYmplY3QoaW5wdXQsIGNvbnRlbnRQYXRoKSA6IGlucHV0O1xuICAgIGNvbnN0IGZpbHRlcmVkVmFsdWVLZXlzID0gWy4uLm5ldyBTZXQodmFsdWVLZXlzKV0uZmlsdGVyKEJvb2xlYW4pO1xuXG4gICAgaWYgKCFkYXRhIHx8ICFBcnJheS5pc0FycmF5KGRhdGEpKSByZXR1cm4gW107XG5cbiAgICBjb25zdCBzbGljZWREYXRhID0gZGF0YS5zbGljZShzbGljZT8uWzBdID8/IDAsIHNsaWNlPy5bMV0gPz8gZGF0YS5sZW5ndGgpO1xuICAgIGNvbnN0IHJlc3VsdDogT3B0aW9uSXRlbVtdID0gc2xpY2VkRGF0YS5tYXAoKGl0ZW06IGFueSkgPT4gKHtcbiAgICAgIGxhYmVsOiBnZXRWYWx1ZUluT2JqZWN0KGl0ZW0sIGxhYmVsS2V5KSxcbiAgICAgIHZhbHVlOiAhZmlsdGVyZWRWYWx1ZUtleXMubGVuZ3RoXG4gICAgICAgID8gaXRlbVxuICAgICAgICA6IHRyaW1PYmplY3RCeUtleXMoaXRlbSwgZmlsdGVyZWRWYWx1ZUtleXMpLFxuICAgIH0pKTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIF9nZXRNYXBwZWRTcmMoc3JjOiBzdHJpbmcsIGJvZHk6IGFueSk6IHN0cmluZyB7XG4gICAgLy8gdXJsIHZhcmlhYmxlcyAoLi4uLzp4Lzp5Lzp6KVxuICAgIGNvbnN0IHVybFZhcmlhYmxlcyA9IHNyYy5tYXRjaCgvOihbXi86XFxzXSspL2cpIHx8IChbXSBhcyBzdHJpbmdbXSk7XG5cbiAgICBpZiAodHlwZW9mIGJvZHkgIT09ICdvYmplY3QnKSB7XG4gICAgICByZXR1cm4gc3JjO1xuICAgIH1cblxuICAgIGlmICghdXJsVmFyaWFibGVzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGAke3NyY30/JHtuZXcgVVJMU2VhcmNoUGFyYW1zKGJvZHkpLnRvU3RyaW5nKCl9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gT2JqZWN0LmtleXMoYm9keSkucmVkdWNlKChhY2MsIGtleSkgPT4ge1xuICAgICAgYWNjID0gYWNjLnJlcGxhY2UoYDoke2tleX1gLCBgJHtib2R5W2tleV19YCk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHNyYyk7XG4gIH1cblxuICBwcml2YXRlIF9tYXBCb2R5VmFsdWUoY29uZmlnOiBPcHRpb25Tb3VyY2VDb25maWcpOiBhbnkge1xuICAgIGlmICghY29uZmlnLnRyaWdnZXIpIHJldHVybiBjb25maWcuYm9keTtcblxuICAgIGNvbnN0IHRyaWdnZXJCb2R5ID0gY29uZmlnLnRyaWdnZXIuYm9keTtcbiAgICBpZiAoIXRyaWdnZXJCb2R5KSByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IGZvcm0gPSB0aGlzLl9nbG9iYWxWYXJpYWJsZVNlcnZpY2Uucm9vdEZvcm07XG4gICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmtleXModHJpZ2dlckJvZHkpLnJlZHVjZSgoYWNjLCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IHsgY29udHJvbFBhdGgsIHZhbHVlUGF0aCB9ID0gZ2V0Q29udHJvbEFuZFZhbHVlUGF0aChcbiAgICAgICAgdHJpZ2dlckJvZHlba2V5XVxuICAgICAgKTtcblxuICAgICAgY29uc3QgY29udHJvbCA9IGZvcm0/LmdldChjb250cm9sUGF0aCk7XG4gICAgICBjb25zdCB2YWx1ZSA9IGdldFZhbHVlSW5PYmplY3QoY29udHJvbD8udmFsdWUsIHZhbHVlUGF0aCk7XG5cbiAgICAgIGFjY1trZXldID0gIWNvbnRyb2wgPyB0cmlnZ2VyQm9keVtrZXldIDogdmFsdWU7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIGFueSk7XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59XG4iXX0=